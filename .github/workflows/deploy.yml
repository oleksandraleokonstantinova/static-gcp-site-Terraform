name: Deploy to Cloud Run via Cloud Build

# Визначаємо, коли запускати Workflow
on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

jobs:
  deploy-to-run:
    # ФІКСУЄМО ВЕРСІЮ UBUNTU: використовуємо LTS-версію для стабільності
    runs-on: ubuntu-22.04 
    
    env:
      PROJECT_ID: massive-triumph-476718-d5
      SERVICE_NAME: static-site-https
      REGION: us-central1 
      IMAGE_TAG: gcr.io/massive-triumph-476718-d5/static-site-https-v1_1

    steps:
      - name: Вивантажити код репозиторію
        uses: actions/checkout@v4

      # 1. Аутентифікація в Google Cloud
      - name: Аутентифікація в GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT_EMAIL }}

      # 2. Збірка Docker-образу та його відправка в GCR/AR
      - name: Запуск Cloud Build та відправка образу
        # ВИКОРИСТОВУЄМО ПРЯМУ КОМАНДУ GCLOUD ДЛЯ ЗБІРКИ
        run: |
          gcloud builds submit . \
            --tag ${{ env.IMAGE_TAG }} \
            --project ${{ env.PROJECT_ID }}

      # 3. Розгортання образу в Cloud Run
      - name: Розгортання в Cloud Run
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ env.SERVICE_NAME }}
          region: ${{ env.REGION }}
          image: ${{ env.IMAGE_TAG }}
          project_id: ${{ env.PROJECT_ID }}
          flags: --platform managed --allow-unauthenticated --port 8080
